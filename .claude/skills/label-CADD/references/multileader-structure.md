# MULTILEADER DXF Structure Reference

Documentation for MULTILEADER entity structure in DXF files, based on analysis of Civil 3D annotative multileaders.

## Entity Structure Overview

```
MULTILEADER entity (ENTITIES section)
    ├── Handle (group 5)
    ├── ACAD_XDICTIONARY (102 block, optional for annotative)
    │       └── 360 → Extension dictionary handle
    ├── Owner (330) → Model space block (1F)
    ├── AcDbEntity
    │       ├── Layer (8)
    │       └── Color (62, omit for ByLayer)
    ├── Binary graphics data (310, regenerated by AutoCAD)
    ├── AcDbMLeader
    │       ├── Version (270)
    │       ├── CONTEXT_DATA (300-301 block)
    │       └── Style reference (340) → MLEADERSTYLE handle
    └── Entity properties
```

## Key Group Codes

### AcDbEntity Section
| Code | Description | Example |
|------|-------------|---------|
| 8 | Layer name | G-ANNO |
| 62 | Color (omit for ByLayer) | 1 (red), 256 (ByLayer) |

### CONTEXT_DATA Block
| Code | Description | Example |
|------|-------------|---------|
| 40 | Scale factor | 20.0 |
| 10/20/30 | Various points | Position coordinates |
| 12/22/32 | Text insertion point | x, y, z |
| 140 | Char height (model units) | 2.0 (at scale 20 = 0.10" paper) |
| 304 | Text content | TEST\\PTESTING 1234.56' |
| 340 | Text style handle | E65 |

### LEADER Section
| Code | Description |
|------|-------------|
| 302 | LEADER{ marker |
| 10/20/30 | Dogleg point |
| 303 | } close marker |

### LEADER_LINE Section
| Code | Description |
|------|-------------|
| 304 | LEADER_LINE{ marker |
| 10/20/30 | Arrow target point (0,0,0 in template) |
| 305 | } close marker |

## MLEADERSTYLE Structure

MLEADERSTYLE entities define the style properties.

### Key Group Codes
| Code | Description | Template Value |
|------|-------------|----------------|
| 170 | Content type | 2 (MTEXT) |
| 173 | Leader line type | 1 (straight) |
| 42 | Landing gap (paper) | 0.05 |
| 43 | Dogleg length (paper) | 0.1 |
| 44 | Arrowhead size (paper) | 0.12 |
| 45 | Text height (paper) | 0.10 |
| 46 | Block scale | 0.18 |
| 91 | Leader line color | -1056964608 (ByBlock) |
| 93 | Text color | -1056964608 (ByBlock) |
| 94 | Arrow color | -1056964608 (ByBlock) |
| 272 | Left text attachment | 9 (underline bottom) |
| 273 | Right text attachment | 9 (underline bottom) |
| 296 | Annotative flag | 1 (true) |
| 342 | Text style handle | E65 |

### Color Values
- `-1056964608` (0xC1000000) = ByBlock
- `256` = ByLayer
- `1-255` = ACI color index

## Annotative Scale Architecture

For annotative behavior, multileaders need an extension dictionary chain:

```
MULTILEADER
    └── XDICTIONARY → DICTIONARY (extension dict)
                          └── AcDbContextDataManager → DICTIONARY
                                  └── ACDB_ANNOTATIONSCALES → DICTIONARY
                                          └── *A1 → ACDB_MLEADEROBJECTCONTEXTDATA_CLASS
```

### Extension Dictionary Chain

1. **Extension Dictionary** (owned by MULTILEADER)
   - Entry: `AcDbContextDataManager` → context manager handle

2. **Context Manager Dictionary**
   - Entry: `ACDB_ANNOTATIONSCALES` → annotation scales dict handle

3. **Annotation Scales Dictionary**
   - Entry: `*A1` → context data handle (one per scale)

4. **ACDB_MLEADEROBJECTCONTEXTDATA_CLASS**
   - Contains duplicate of MULTILEADER geometry for this scale
   - Group 340: SCALE object handle
   - Group 40: Scale factor

### SCALE Objects

SCALE objects are stored in ACAD_SCALELIST dictionary:

```
SCALE
  5     → handle
330     → owner (ACAD_SCALELIST dict, handle B6)
100     → AcDbScale
 70     → flags
300     → name ("1\" = 20'")
140     → paper units (1.0)
141     → drawing units (20.0)
290     → is default
```

## Spatial Relationship

The template MULTILEADER geometry is designed with arrow at origin (0,0,0):

```
┌──────────────────┐
│ TEST             │  ← Text insertion (12/22/32)
│ TESTING 1234.56' │
└──────────────────┘
         │ dogleg
         └─────────●  ← Arrow at (0,0,0)
```

When cloning, all position coordinates are offset by (dx, dy, dz):
- Groups 10, 12, 110: X positions
- Groups 20, 22, 120: Y positions
- Groups 30, 32, 130: Z positions

Direction vectors (11/21/31, 13/23/33, etc.) are NOT offset.

## Text Formatting

- Line breaks: `\P` (paragraph break)
- Example: `CP 10\PELEV: 3456.78'`
- ALL CAPS for presentation labels
- Original case for drafter notes

## Color Cascade

For ByLayer color on all components:

1. Entity level: Omit group 62 (defaults to ByLayer)
2. MLEADERSTYLE: Set leader/text/arrow colors to ByBlock (-1056964608)
3. Result: All components inherit from entity → layer color

## Files

- Template: `templates/mleader-template.dxf`
- Contains MLEADERSTYLE "Annotative-Simplex" and pre-defined SCALE objects
